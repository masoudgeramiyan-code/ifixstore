<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ورود / ثبت نام</title>
<style>
:root{
--bg:#f4f6f8;--card:#ffffff;--accent:#4CAF50;--accent-2:#45a049;
--muted:#6b7280;--danger:#f44336;--success:#2d9c3a;
--radius:10px;--shadow:0 6px 18px rgba(20,20,30,0.08);
font-family:"Vazirmatn",Arial,sans-serif;
}
html,body{height:100%;margin:0;background:var(--bg);direction:rtl}
.wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:24px}
.card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:28px;width:380px;max-width:95%;text-align:center}
h1{margin:0 0 12px;font-size:20px}
.btns{display:flex;gap:12px;justify-content:center;margin:14px 0 6px}
button.btn{flex:1;padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer;font-weight:600;}
button.btn.secondary{background:#0ea5a5}
button.btn:active{transform:translateY(1px)}
.hint{color:var(--muted);font-size:13px;margin-top:6px}
.modal{display:none;position:fixed;z-index:1200;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.35);align-items:center;justify-content:center;padding:20px}
.modal.show{display:flex}
.modal-card{width:100%;max-width:420px;background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);position:relative}
.modal .close{position:absolute;left:14px;top:10px;color:#999;font-size:22px;border:none;background:transparent;cursor:pointer}
.modal-card h2{margin:0 0 10px;font-size:18px}
.form-row{margin:10px 0}
input[type="text"],input[type="email"],input[type="password"],select{
width:100%;padding:10px;border-radius:8px;border:1px solid #e5e7eb;font-size:14px;box-sizing:border-box;
}
select{background:#fff}
.submit{margin-top:8px;padding:10px;border-radius:8px;border:none;background:var(--accent);color:#fff;width:100%;cursor:pointer;font-weight:600;}
.error-text{color:var(--danger);font-size:13px;margin-top:6px;display:none}
.toast-wrap{position:fixed;left:50%;transform:translateX(-50%);bottom:28px;z-index:2000}
.toast{min-width:280px;max-width:90vw;padding:12px 14px;border-radius:10px;color:#fff;display:flex;align-items:center;gap:10px;box-shadow:0 6px 20px rgba(0,0,0,0.12);font-weight:600;font-size:14px;opacity:0;pointer-events:none;transition:all .28s ease;}
.toast.show{opacity:1;pointer-events:auto;transform:translateY(-6px)}
.toast.error{background:linear-gradient(90deg,#d64545,#f44336)}
.toast.success{background:linear-gradient(90deg,#28a745,#2d9c3a)}
.muted{color:var(--muted);font-size:13px;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
<div class="card" role="main">
<h1>ورود یا ثبت نام</h1>
<div class="btns">
<button id="loginBtn" class="btn">ورود</button>
<button id="signupBtn" class="btn secondary">ثبت نام</button>
</div>
<div class="hint">از دکمه‌ها استفاده کنید تا فرم مناسب باز شود.</div>
</div>
</div>

<!-- Login Modal -->
<div id="loginModal" class="modal" aria-hidden="true">
<div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
<button class="close" id="closeLogin" aria-label="بستن">&times;</button>
<h2 id="loginTitle">ورود به حساب کاربری</h2>
<form id="loginForm" autocomplete="on">
<input type="hidden" name="formType" value="login">
<div class="form-row">
<input id="loginEmail" name="email" type="email" placeholder="ایمیل (انگلیسی)" required
pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" title="ایمیل باید با حروف انگلیسی باشد.">
</div>
<div class="form-row">
<input id="loginPassword" name="password" type="password" placeholder="رمز عبور" required minlength="6"
                 pattern="^[A-Za-z0-9!@#$%^&*()_+=\-{}\[\]:;\"'<>
</div>
<div class="error-text" id="loginError"></div>
<button class="submit" type="submit">ورود</button>
<div class="note muted">اگر حساب ندارید، از ثبت نام استفاده کنید.</div>
</form>
</div>
</div>

<!-- Signup Modal -->
<div id="signupModal" class="modal" aria-hidden="true">
<div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="signupTitle">
<button class="close" id="closeSignup" aria-label="بستن">&times;</button>
<h2 id="signupTitle">ثبت نام</h2>
<form id="signupForm" autocomplete="on">
<input type="hidden" name="formType" value="signup">
<input type="hidden" name="role" value="manager">

<div class="form-row">
<input id="fullname" name="fullname" type="text" placeholder="نام کامل (فقط فارسی)" required
pattern="^[\u0600-\u06FF\s]+$" title="فقط حروف فارسی مجاز است.">
</div>

<div class="form-row">
<input id="phone" name="phone" type="text" placeholder="شماره تماس (فقط ارقام انگلیسی)" required
pattern="^[0-9]+$" title="فقط ارقام 0-9 انگلیسی مجاز است.">
</div>

<div class="form-row">
<input id="business_name" name="business_name" type="text" placeholder="نام کسب‌وکار (فقط فارسی)" required
pattern="^[\u0600-\u06FF\s]+$" title="فقط حروف فارسی مجاز است.">
</div>

<div class="form-row">
<select id="job_type" name="job_type_id" required>
<option value="">در حال بارگذاری نوع شغل...</option>
</select>
</div>

<div class="form-row">
<input id="email" name="email" type="email" placeholder="ایمیل (انگلیسی)" required
pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" title="ایمیل باید با حروف انگلیسی باشد.">
</div>

<div class="form-row">
<input id="password" name="password" type="password" placeholder="رمز عبور" minlength="6" required
                 pattern="^[A-Za-z0-9!@#$%^&*()_+=\-{}\[\]:;\"'<>
</div>

<div class="form-row">
<input id="confirmPassword" name="confirmPassword" type="password" placeholder="تأیید رمز عبور" minlength="6" required>
</div>

<div class="error-text" id="signupError"></div>
<button class="submit" type="submit">ثبت نام</button>
</form>
</div>
</div>

<div class="toast-wrap" aria-live="polite" aria-atomic="true">
<div id="toast" class="toast"><span class="icon" id="toastIcon"></span><span id="toastText"></span></div>
</div>

<script>
// ---------- CONFIG ----------
const WEBHOOK_URL = "https://carolina-emulsive-writerly.ngrok-free.dev/webhook/get-job-types";
const JOB_LIST_URL = "https://carolina-emulsive-writerly.ngrok-free.dev/webhook/get-job-types";

// ---------- helpers ----------
const $ = (id)=>document.getElementById(id);
function showToast({type="error", text="", timeout=3500}){
const t = $("toast");
const icon = $("toastIcon");
const txt = $("toastText");
t.className = "toast " + (type==="success" ? "success" : "error");
txt.textContent = text;
icon.innerHTML = ""; // keep simple
t.classList.add("show");
clearTimeout(t._t);
t._t = setTimeout(()=> t.classList.remove("show"), timeout);
}

// ---------- modal logic ----------
const loginBtn = $("loginBtn"), signupBtn = $("signupBtn");
const loginModal = $("loginModal"), signupModal = $("signupModal");
const closeLogin = $("closeLogin"), closeSignup = $("closeSignup");
const loginForm = $("loginForm"), signupForm = $("signupForm");

function openLogin(){
signupModal.classList.remove("show");
signupModal.setAttribute("aria-hidden","true");
loginModal.classList.add("show");
loginModal.setAttribute("aria-hidden","false");
setTimeout(()=> $("loginEmail").focus(),80);
}
function openSignup(){
loginModal.classList.remove("show");
loginModal.setAttribute("aria-hidden","true");
signupModal.classList.add("show");
signupModal.setAttribute("aria-hidden","false");
setTimeout(()=> $("fullname").focus(),80);
}
loginBtn.addEventListener("click", openLogin);
signupBtn.addEventListener("click", openSignup);
closeLogin.addEventListener("click", ()=> { loginModal.classList.remove("show"); loginModal.setAttribute("aria-hidden","true"); });
closeSignup.addEventListener("click", ()=> { signupModal.classList.remove("show"); signupModal.setAttribute("aria-hidden","true"); });
window.addEventListener("click",(e)=>{
if(e.target===loginModal){ loginModal.classList.remove("show"); loginModal.setAttribute("aria-hidden","true"); }
if(e.target===signupModal){ signupModal.classList.remove("show"); signupModal.setAttribute("aria-hidden","true"); }
});

// ---------- input sanitizers (UX) ----------
// fullname/business: remove latin letters & digits while typing
function allowOnlyPersianText(evt){
const el = evt.target;
// keep Persian letters, spaces, and remove others
const cleaned = (el.value.match(/[\u0600-\u06FF\s]+/g) || []).join('');
if(cleaned !== el.value) el.value = cleaned;
}
// phone: keep only ASCII digits
function allowOnlyAsciiDigits(evt){
const el = evt.target;
const cleaned = (el.value.match(/[0-9]+/g) || []).join('');
if(cleaned !== el.value) el.value = cleaned;
}
// password: remove any Persian/Arabic letters (block non-ascii range roughly)
function sanitizePasswordInput(evt){
const el = evt.target;
// allow ASCII printable chars
const cleaned = (el.value.match(/[A-Za-z0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?`~]+/g) || []).join('');
if(cleaned !== el.value) el.value = cleaned;
}

$("fullname").addEventListener("input", allowOnlyPersianText);
$("business_name").addEventListener("input", allowOnlyPersianText);
$("phone").addEventListener("input", allowOnlyAsciiDigits);

$("password").addEventListener("input", sanitizePasswordInput);
$("confirmPassword").addEventListener("input", sanitizePasswordInput);
$("loginPassword").addEventListener("input", sanitizePasswordInput);

// ---------- load job types ----------
async function loadJobTypes(){
const select=$("job_type");
// initial state
select.innerHTML = '<option value="">در حال بارگذاری نوع شغل...</option>';
try{
const res = await fetch(JOB_LIST_URL, { method: 'GET', cache: 'no-store' });
if(!res.ok){
// try to read body for message
let text;
try{ text = await res.text(); }catch(e){ text = res.statusText || 'خطای شبکه'; }
console.error('job-types fetch failed', res.status, text);
select.innerHTML = '<option value="">خطا در بارگذاری (' + res.status + ')</option>';
return;
}
// parse JSON safely
let data;
try { data = await res.json(); } catch(e){ console.error('invalid json job-types', e); select.innerHTML = '<option value="">پاسخ نامعتبر از سرور</option>'; return; }

// n8n / supabase usually returns an array; handle wrapped forms
let arr = [];
if(Array.isArray(data)) arr = data;
else if(Array.isArray(data.data)) arr = data.data;
else if(Array.isArray(data.rows)) arr = data.rows;
else {
// try to find first array in response
for(const k of Object.keys(data)){
if(Array.isArray(data[k])){ arr = data[k]; break; }
}
}

if(!arr || arr.length === 0){
select.innerHTML = '<option value="">لیست خالی است</option>';
return;
}

// populate (expect objects with id and job_name)
select.innerHTML = '<option value="">انتخاب نوع شغل</option>';
arr.forEach(job=>{
const opt = document.createElement('option');
opt.value = job.id ?? job.uuid ?? job._id ?? '';
opt.textContent = job.job_name ?? job.jobName ?? job.name ?? job.title ?? String(job.id);
select.appendChild(opt);
});

}catch(err){
console.error('error loading job types', err);
select.innerHTML = '<option value="">خطا در بارگذاری</option>';
}
}
// call load
loadJobTypes();

// ---------- submit helper ----------
async function submitFormAsJson(formElement, onSuccess, onError){
const fm = new FormData(formElement);
try {
const res = await fetch(WEBHOOK_URL, { method: "POST", body: fm });
let data = null;
try { data = await res.json(); } catch(e){ /* ignore */ }
if(res.ok){
onSuccess?.(data ?? { status: "ok" });
} else {
onError?.(data ?? { status: "error", message: res.statusText || 'خطا' });
}
} catch(err){
onError?.({ status: "error", message: "خطا در ارتباط با سرور" });
}
}

// ---------- login logic ----------
loginForm.addEventListener("submit", function(e){
e.preventDefault();
const email = loginForm.email.value.trim();
const password = loginForm.password.value;
// basic validation: pattern attributes already handle, but extra checks:
if(!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email)){
showToast({text:"ایمیل نامعتبر است — از حروف انگلیسی استفاده کنید."});
return;
}
if(!/^[A-Za-z0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?`~]{6,}$/.test(password)){
showToast({text:"رمز عبور نامعتبر است — حداقل 6 نویسه و فقط کاراکترهای مجاز انگلیسی."});
return;
}

submitFormAsJson(loginForm,
(data)=>{ showToast({type:"success", text: data?.message || "ورود با موفقیت انجام شد."}); loginModal.classList.remove("show"); },
(err)=>{ showToast({text: err?.message || "ورود ناموفق — ایمیل یا رمز اشتباه است."}); }
);
});

// ---------- signup logic ----------
signupForm.addEventListener("submit", function(e){
e.preventDefault();
const fullname = signupForm.fullname.value.trim();
const phone = signupForm.phone.value.trim();
const business = signupForm.business_name.value.trim();
const jobType = signupForm.job_type_id.value;
const email = signupForm.email.value.trim();
const password = signupForm.password.value;
const confirm = signupForm.confirmPassword.value;

if(fullname.length < 2 || !/^[\u0600-\u06FF\s]+$/.test(fullname)){
showToast({text:"نام کامل فقط باید حروف فارسی و حداقل 2 حرف باشد."}); return;
}
if(!/^[0-9]+$/.test(phone)){
showToast({text:"شماره تماس فقط باید ارقام انگلیسی 0-9 باشد."}); return;
}
if(business.length < 2 || !/^[\u0600-\u06FF\s]+$/.test(business)){
showToast({text:"نام کسب‌وکار فقط باید حروف فارسی باشد."}); return;
}
if(!jobType){
showToast({text:"لطفاً نوع شغل را انتخاب کنید."}); return;
}
if(!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email)){
showToast({text:"ایمیل نامعتبر است — از حروف انگلیسی استفاده کنید."}); return;
}
if(!/^[A-Za-z0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?`~]{6,}$/.test(password)){
showToast({text:"رمز عبور نامعتبر — حداقل 6 نویسه و بدون حروف فارسی."}); return;
}
if(password !== confirm){
showToast({text:"رمز عبور و تکرار آن یکسان نیست!"}); return;
}

// Submit
submitFormAsJson(signupForm,
(data)=>{ showToast({type:"success", text: data?.message || "ثبت‌نام با موفقیت انجام شد."}); signupForm.reset(); signupModal.classList.remove("show"); },
(err)=>{ showToast({text: err?.message || "خطا در ثبت‌نام — دوباره تلاش کنید."}); }
);
});

</script>
</body>
</html>
